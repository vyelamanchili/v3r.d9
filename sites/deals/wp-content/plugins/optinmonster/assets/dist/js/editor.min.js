(()=>{"use strict";var n=function(n){return OMAPI.monsterlink+n+"/"};window.OMAPI_Editor=window.OMAPI_Editor||{},function(t,e,i,o,l){t.OMAPI=t.OMAPI||{},OMAPI.monsterlink=o.monsterlink,o.getActiveEditorId=function(){var n=t.wpActiveEditor,e=t.tinymce;return wp.media.editor.activeEditor&&(n=wp.media.editor.activeEditor),!n&&e&&e.activeEditor&&(n=e.activeEditor.id),n},o.getActiveEditor=function(){var n=o.getActiveEditorId();return n&&t.tinymce?t.tinymce.get(n):null},o.mceLinkifyText=function(){var t=o.$select.val();t&&o.getActiveEditor().execCommand("mceInsertLink",!1,{href:n(t),target:"_blank",rel:"noopener noreferrer"})},o.modalOpenLink=function(){o.$toToggle.addClass("optin-monster-modal-monsterlink").removeClass("optin-monster-modal-inline"),o.$body.addClass("modal-open om-modal-open-monsterlink"),o.$modalWrap.show(),o.updateLinkSelectOptions(o.$select),i(".wp-link-input").parent().find(".dashicons-admin-generic").parent().click(),i(e).trigger("om-modal-open-monsterlink")},o.modalOpenInline=function(){o.$toToggle.addClass("optin-monster-modal-inline").removeClass("optin-monster-modal-monsterlink").show(),o.$body.addClass("modal-open om-modal-open-inline"),o.updateInlineSelectOptions(),i(e).trigger("om-modal-open-inline")},o.modalClose=function(){["$select","$linkSelect","$inlineSelect"].forEach((function(n){o[n]&&o[n].length&&o[n].val("")})),o.$toToggle.hide();var n=o.$body.hasClass("om-modal-open-monsterlink")?"monsterlink":"inline";o.$body.removeClass("modal-open om-modal-open-monsterlink om-modal-open-inline"),i(e).trigger("om-modal-close-".concat(n))},o.insertShortcode=function(){var n=o.$inlineSelect.val();n&&wp.media.editor.insert('[optin-monster slug="'.concat(n,'" followrules="true"]'))},o.updateLinkSelectOptions=function(t){var e=i("#wp-link-wrap #link-selector"),o=e.find("#search-panel"),l=o.offset().top+o.outerHeight()-e.offset().top+12;i(".has-text-field #wp-link .query-results").css({top:l});var a=i(".wp-link-input input.ui-autocomplete-input").val();a&&t.find("option").each((function(){var e=i(this).val();e&&a===n(e)&&t.val(e)}))},o.updateInlineSelectOptions=function(){var n=o.getActiveEditorId();if(n){var t=o.getActiveEditor(),l=t&&!t.isHidden()?t.getContent():e.getElementById(n).value;o.$inlineSelect.find("option").each((function(){var n=i(this),t=l.indexOf('optin-monster slug="'.concat(n.val(),'"'))>=0;n.attr("disabled",t)}))}},o.initLinkButton=function(){i(".wp-link-input").each((function(){var n=i(this).parent();if(!n.find(".optin-monster-insert-monsterlink").length){var t=i('<div class="mce-widget mce-btn mce-last" tabindex="-1" role="button" aria-label="OptinMonster" style="margin-left:-3px;"></div>'),e=i('<button role="presentation" type="button" tabindex="-1" class="optin-monster-insert-monsterlink"></button>');e.append(i(".wp-media-buttons-icon.optin-monster-menu-icon").first().clone()),t.append(e),n.find(".mce-last").removeClass("mce-last"),n.append(t)}}))},o.initAdvancedSettings=function(){var e=i('\n\t\t\t<p class="howto" id="om-link-campaign-label">'.concat(o.i18n.or_monsterlink,'</p>\n\t\t\t<div style="margin-bottom: -8px;">\n\t\t\t\t').concat(o.canMonsterlink?'<label><span>Select</span>\n\t\t\t\t\t\t<select name="om-link-class" id="om-link-campaign" aria-describedby="om-link-campaign-label">\n\t\t\t\t\t\t</select>\n\t\t\t\t\t</label>':'<p class="om-monsterlink-upgrade"><span>'.concat(o.i18n.upgrade_monsterlink,'</span> <a href="').concat(o.upgradeUri.replace("--FEATURE--","monster-link"),'" target="_blank" rel="noopener">').concat(o.i18n.upgrade,"</a></p>"),"\n\t\t\t</div>\n\t\t"));if(e.find("select").html(o.$select.find("option").clone()),e.find(".om-monsterlink-upgrade").length){var l=i("#om-monsterlink-upgrade").clone();e.find(".om-monsterlink-upgrade span").html(l.html())}if(i("#link-options").append(e),o.$linkSelect=i("#om-link-campaign"),void 0!==t.wpLink){var a=wpLink.getAttrs;wpLink.getAttrs=function(){var t=a(),e=n(o.$linkSelect.val());return t.href===e&&(t.target="_blank",t.rel="noopener noreferrer"),t}}},o.initEditorMods=function(n){n&&!n.hasInitiatedOm&&(n.hasInitiatedOm=!0,n.on("ExecCommand",(function(n){"WP_Link"===n.command&&o.initLinkButton()})),o.$linkSelect||o.initAdvancedSettings())},o.setupListeners=function(){i(e).on("click",".optin-monster-insert-campaign-button",(function(n){n.preventDefault(),o.modalOpenInline()})).on("click",".optin-monster-insert-monsterlink",(function(n){n.preventDefault(),o.modalOpenLink()})).on("click","#optin-monster-modal-backdrop, #optin-monster-modal-close, #optin-monster-modal-cancel a",(function(n){n.preventDefault(),o.modalClose()})).on("click","#optin-monster-modal-submit-inline",(function(n){n.preventDefault(),o.insertShortcode(),o.modalClose()})).on("click","#optin-monster-modal-submit",(function(n){n.preventDefault(),o.mceLinkifyText(),o.modalClose()})).on("change","#om-link-campaign",(function(){var t=o.$linkSelect.val();t&&(i("#wp-link-url").val(n(t)),i("#wp-link-target").prop("checked",!0))})).on("wplink-open",(function(n){o.updateLinkSelectOptions(o.$linkSelect)})).on("wplink-close",(function(n){o.modalClose()})).on("om-modal-close-monsterlink",(function(n){if(wpLink){var t=o.getActiveEditor();t&&!t.isHidden()&&wpLink.close()}}))},o.init=function(){o.$body=i(e.body),o.$modalWrap=i("#optin-monster-modal-wrap"),o.$toToggle=i("#optin-monster-modal-backdrop, #optin-monster-modal-wrap"),o.$select=i("#optin-monster-modal-select-campaign"),o.$inlineSelect=i("#optin-monster-modal-select-inline-campaign"),o.$linkSelect=null,o.setupListeners(),o.initEditorMods(o.getActiveEditor()),"undefined"!=typeof tinymce&&tinymce.on("SetupEditor",(function(n){var t=n.editor;o.initEditorMods(t)}))},i(o.init)}(window,document,jQuery,window.OMAPI_Editor)})();